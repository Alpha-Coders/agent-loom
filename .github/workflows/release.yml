name: Release

# macOS Code Signing (Optional)
# -----------------------------
# For unsigned builds, users must run `xattr -cr /Applications/AgentLoom.app` before first launch.
# To enable automatic code signing and notarization, set these repository secrets:
#
#   APPLE_CERTIFICATE          - Base64-encoded .p12 certificate (Developer ID Application)
#   APPLE_CERTIFICATE_PASSWORD - Password for the .p12 certificate
#   KEYCHAIN_PASSWORD          - Temporary keychain password (any secure value)
#   APPLE_SIGNING_IDENTITY     - Certificate name, e.g., "Developer ID Application: Your Name (TEAMID)"
#   APPLE_ID                   - Your Apple ID email (for notarization)
#   APPLE_PASSWORD             - App-specific password from appleid.apple.com
#   APPLE_TEAM_ID              - Your 10-character Team ID
#
# To export your certificate as base64:
#   base64 -i certificate.p12 | pbcopy

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version override (e.g., 0.1.0-beta.1)'
        required: false
        type: string
      skip_validation:
        description: 'Skip validation checks (clippy, tests)'
        required: false
        type: boolean
        default: false

# Minimal permissions by default
permissions:
  contents: read

# Cancel in-progress runs for the same ref
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Validation job - runs before building
  validate:
    if: ${{ !inputs.skip_validation }}
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Install Linux dependencies
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf
          version: 1.0

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: validate

      - name: Run clippy
        # Only validate library crates - Tauri app requires frontend to be built
        run: cargo clippy -p agentloom-core -p agentloom-cli --all-targets -- -D warnings

      - name: Run tests
        run: cargo test -p agentloom-core -p agentloom-cli

  build:
    needs: [validate]
    # Run even if validate was skipped
    if: ${{ always() && (needs.validate.result == 'success' || needs.validate.result == 'skipped') }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            target: aarch64-apple-darwin
            arch: arm64
          - platform: macos-latest
            target: x86_64-apple-darwin
            arch: x64
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            arch: x64
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            arch: x64

    runs-on: ${{ matrix.platform }}
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: build-${{ matrix.target }}
          # Cache the target directory for faster builds
          cache-targets: true

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf
          version: 1.0

      - name: Install npm dependencies
        run: npm ci

      - name: Determine version
        id: version
        shell: bash
        env:
          INPUT_VERSION: ${{ inputs.version }}
          GH_REF: ${{ github.ref }}
        run: |
          if [ -n "$INPUT_VERSION" ]; then
            echo "version=$INPUT_VERSION" >> $GITHUB_OUTPUT
          elif [[ "$GH_REF" == refs/tags/v* ]]; then
            echo "version=${GH_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            echo "version=$(node -p "require('./package.json').version")-dev" >> $GITHUB_OUTPUT
          fi

      - name: Import Apple signing certificate
        if: ${{ matrix.platform == 'macos-latest' && secrets.APPLE_CERTIFICATE != '' }}
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Create a temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          echo "$APPLE_CERTIFICATE" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"

          # Allow codesign to access the key
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

      - name: Build (macOS)
        if: matrix.platform == 'macos-latest'
        env:
          TARGET: ${{ matrix.target }}
          # Tauri signing environment variables (only used if secrets exist)
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: npm run tauri build -- --target "$TARGET" --bundles dmg

      - name: Build (Linux)
        if: matrix.platform == 'ubuntu-22.04'
        env:
          TARGET: ${{ matrix.target }}
        run: npm run tauri build -- --target "$TARGET" --bundles appimage

      - name: Build (Windows)
        if: matrix.platform == 'windows-latest'
        shell: bash
        env:
          TARGET: ${{ matrix.target }}
        run: npm run tauri build -- --target "$TARGET" --bundles nsis

      - name: Cleanup Apple keychain
        if: matrix.platform == 'macos-latest' && always()
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          if [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH" || true
          fi

      - name: Package macOS artifact
        if: matrix.platform == 'macos-latest'
        env:
          VERSION: ${{ steps.version.outputs.version }}
          ARCH: ${{ matrix.arch }}
          TARGET: ${{ matrix.target }}
        run: |
          # Tauri builds DMG to workspace root target/
          DMG_PATH=$(find target -name "*.dmg" -path "*/$TARGET/release/bundle/dmg/*" 2>/dev/null | head -1)
          if [ -z "$DMG_PATH" ]; then
            echo "Error: Could not find DMG file"
            find target -type d -name "bundle" -exec ls -laR {} \; 2>/dev/null || true
            exit 1
          fi
          echo "Found at: $DMG_PATH"

          DMG_NAME="AgentLoom-${VERSION}-macos-${ARCH}.dmg"
          cp "$DMG_PATH" "$DMG_NAME"
          echo "artifact_name=${DMG_NAME}" >> $GITHUB_ENV

      - name: Package Linux artifact
        if: matrix.platform == 'ubuntu-22.04'
        env:
          VERSION: ${{ steps.version.outputs.version }}
          TARGET: ${{ matrix.target }}
        run: |
          # Tauri builds to workspace root target/, not src-tauri/target/
          APPIMAGE=$(find target -name "*.AppImage" 2>/dev/null | head -1)
          if [ -z "$APPIMAGE" ]; then
            echo "Error: Could not find AppImage"
            find target -type d -name "bundle" -exec ls -la {} \; 2>/dev/null || true
            exit 1
          fi
          echo "Found: $APPIMAGE"

          NEW_NAME="AgentLoom-${VERSION}-linux-x64.AppImage"
          cp "$APPIMAGE" "$NEW_NAME"
          chmod +x "$NEW_NAME"
          echo "artifact_name=${NEW_NAME}" >> $GITHUB_ENV

      - name: Package Windows artifact
        if: matrix.platform == 'windows-latest'
        shell: bash
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          # Tauri builds to workspace root target/, not src-tauri/target/
          EXE=$(find target -name "*setup*.exe" -path "*/release/bundle/nsis/*" 2>/dev/null | head -1)
          if [ -z "$EXE" ]; then
            EXE=$(find target -name "*.exe" -path "*/bundle/nsis/*" 2>/dev/null | head -1)
          fi
          if [ -z "$EXE" ]; then
            echo "Error: Could not find NSIS installer"
            find target -type d -name "bundle" -exec ls -laR {} \; 2>/dev/null || true
            exit 1
          fi
          echo "Found: $EXE"

          NEW_NAME="AgentLoom-${VERSION}-windows-x64-setup.exe"
          cp "$EXE" "$NEW_NAME"
          echo "artifact_name=${NEW_NAME}" >> $GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: AgentLoom-${{ matrix.platform }}-${{ matrix.arch }}
          path: ${{ env.artifact_name }}
          if-no-files-found: error
          retention-days: 7

  release:
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/

      - name: Generate checksums
        id: checksums
        run: |
          cd artifacts
          sha256sum * > checksums.txt
          cat checksums.txt

          # Extract SHA256 for macOS DMGs (for Homebrew cask)
          ARM64_SHA=$(sha256sum *-macos-arm64.dmg 2>/dev/null | cut -d' ' -f1 || echo "")
          X64_SHA=$(sha256sum *-macos-x64.dmg 2>/dev/null | cut -d' ' -f1 || echo "")
          echo "arm64_sha=$ARM64_SHA" >> $GITHUB_OUTPUT
          echo "x64_sha=$X64_SHA" >> $GITHUB_OUTPUT

      - name: Determine version and release type
        id: release_info
        env:
          INPUT_VERSION: ${{ inputs.version }}
          GH_REF: ${{ github.ref }}
        run: |
          if [ -n "$INPUT_VERSION" ]; then
            VERSION="$INPUT_VERSION"
            DRAFT="true"
            PRERELEASE="true"
          elif [[ "$GH_REF" == refs/tags/v* ]]; then
            VERSION="${GH_REF#refs/tags/v}"
            DRAFT="false"
            # Mark as prerelease if version contains hyphen (e.g., 0.1.0-beta.1)
            if [[ "$VERSION" == *-* ]]; then
              PRERELEASE="true"
            else
              PRERELEASE="false"
            fi
          else
            VERSION="dev-$(date +%Y%m%d)"
            DRAFT="true"
            PRERELEASE="true"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "draft=$DRAFT" >> $GITHUB_OUTPUT
          echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Update Homebrew cask
        env:
          VERSION: ${{ steps.release_info.outputs.version }}
          ARM64_SHA: ${{ steps.checksums.outputs.arm64_sha }}
          X64_SHA: ${{ steps.checksums.outputs.x64_sha }}
        run: |
          CASK_FILE="Casks/agentloom.rb"

          # Update version
          sed -i 's/version "[^"]*"/version "'"$VERSION"'"/' "$CASK_FILE"

          # Update SHA256 checksums (handles both placeholder and existing hashes)
          sed -i 's/sha256 arm:   "[^"]*"/sha256 arm:   "'"$ARM64_SHA"'"/' "$CASK_FILE"
          sed -i 's/intel: "[^"]*"/intel: "'"$X64_SHA"'"/' "$CASK_FILE"

          echo "Updated Homebrew cask:"
          cat "$CASK_FILE"

      - name: Commit Homebrew cask update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/agentloom.rb
          git diff --staged --quiet || git commit -m "chore: update Homebrew cask to ${{ steps.release_info.outputs.version }}"
          git push origin HEAD:main || echo "Push failed - may need to manually update cask"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_info.outputs.tag }}
          name: AgentLoom ${{ steps.release_info.outputs.version }}
          draft: ${{ steps.release_info.outputs.draft }}
          prerelease: ${{ steps.release_info.outputs.prerelease }}
          generate_release_notes: true
          files: |
            artifacts/*
          body: |
            ## AgentLoom ${{ steps.release_info.outputs.version }}

            ### Installation

            **macOS (Recommended):**
            ```bash
            brew tap Alpha-Coders/agentloom https://github.com/Alpha-Coders/agent-loom.git
            brew install --cask --no-quarantine agentloom
            ```

            **Linux:**
            ```bash
            chmod +x AgentLoom-*-linux-x64.AppImage
            ./AgentLoom-*-linux-x64.AppImage
            ```

            **Windows:** Download and run the setup installer below.

            ### Direct Downloads

            | Platform | Architecture | Download |
            |----------|--------------|----------|
            | macOS | Apple Silicon (M1/M2) | `AgentLoom-${{ steps.release_info.outputs.version }}-macos-arm64.dmg` |
            | macOS | Intel | `AgentLoom-${{ steps.release_info.outputs.version }}-macos-x64.dmg` |
            | Linux | x64 | `AgentLoom-${{ steps.release_info.outputs.version }}-linux-x64.AppImage` |
            | Windows | x64 | `AgentLoom-${{ steps.release_info.outputs.version }}-windows-x64-setup.exe` |

            <details>
            <summary>Manual macOS installation (if not using Homebrew)</summary>

            1. Download and open the `.dmg` file
            2. Drag `AgentLoom.app` to your Applications folder
            3. **Important:** Before first launch, open Terminal and run:
               ```bash
               xattr -cr /Applications/AgentLoom.app
               ```
            4. Now you can open AgentLoom normally

            > The app is not signed with an Apple Developer certificate. Without the `xattr` command, macOS will show a "damaged" error.
            </details>

            ### Checksums

            See `checksums.txt` for SHA256 verification.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
